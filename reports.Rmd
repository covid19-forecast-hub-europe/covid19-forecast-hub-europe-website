---
title: "Weekly reports"
output:
  html_document:
    toc: false
    toc_float: false
---

<p id="intro">
Choose the date and type of report you wish do view using the dropdown menu. The _Ensemble_ report shows the recent forecasts and performance of the ensemble, whereas the _Evaluation_ report shows model-by-model performance, overall and by country. The reports get updated every Tuesday.
</p>

```{r load, include = FALSE}
library(vroom)
library(gh)

locations_url <-
  paste("https://raw.githubusercontent.com",
        "epiforecasts",
        "covid19-forecast-hub-europe",
        "main",
        "data-locations",
        "locations_eu.csv",
        sep = "/")
countries <- sort(vroom(locations_url)$location_name)

ensemble_reports <- list.files("reports", pattern = "^ensemble-report")
ensemble_report_dates <-
  as.Date(sub("^ensemble-report-(.+).html", "\\1", ensemble_reports))

evaluation_overall_reports <-
  list.files("reports", pattern = "^evaluation-report.*-Overall.html")
evaluation_report_dates <-
  as.Date(sub("^evaluation-report-(.+)-Overall.html", "\\1",
              evaluation_overall_reports))

ensemble_files <- gh(
  "/repos/{owner}/{repo}/contents/{path}",
  owner = "epiforecasts",
  repo = "covid19-forecast-hub-europe",
  path = "data-processed/EuroCOVIDhub-ensemble")
ensemble_filenames <-
  grep("\\.csv$", vapply(ensemble_files, "[[", "", "name"), value = TRUE)
dates <- as.Date(substr(ensemble_filenames, 1, 10))
dates <- sort(dates[dates >= "2021-03-22"], decreasing = TRUE)
```

<script>
function getURL(date, report, country) {
  var str = "reports/";
  str = str.concat(report, "-report-", date);
  if (!(report === "ensemble")) {
    str = str.concat("-", country);
  }
  str = str.concat(".html");
  return(str);
}

function updateIframe() {
  var date = date_options.options[date_options.selectedIndex].value;
  var report = report_options.options[report_options.selectedIndex].value;
  var country = country_options.options[country_options.selectedIndex].value;
  if (report == "evaluation") {
    country_options.style.visibility = "visible";
  } else {
    country_options.style.visibility = "hidden";
  }
  document.getElementById('reportFrame').src = getURL(date, report, country);
}

var resize_iframe = function() {
    return function(){
        var textHeight = document.getElementById('intro').clientHeight;
        var element = document.getElementById('reportFrame');
        element.style = 'height: calc(100vh - ' + (textHeight + 220) + 'px);'
    };
};
window.onload = resize_iframe();
window.onresize = resize_iframe();
</script>

```{r dates, results = 'asis', echo = FALSE}
cat("<select id=\"date_options\" name=\"date_options\" onchange=\"updateIframe()\">\n")
for (date in as.character(dates)) {
  cat(paste0("<option value=\"", date, "\">", date, "</option>\n"))
}
cat("</select>\n")
```
<select id="report_options" name="report_options" onchange="updateIframe()">
<option value="ensemble">Ensemble</option>
<option value="evaluation">Evaluation</option>
</select>
```{r countries, results = 'asis', echo = FALSE}
cat("<select id=\"country_options\" name=\"country_options\" ",
    "onchange=\"updateIframe()\" style=\"visibility: hidden\">\n")
cat("<option value=\"Overall\">Overall</option>\n")
for (country in countries) {
  cat(paste0("<option value=\"", country, "\">", country, "</option>\n"))
}
cat("</select>\n")
```
<style>
div.main-container {
    max-width: none;
}
body{
    padding-bottom: 0px;
}
</style>


<hr>

```{r iframe, results = 'asis', echo = FALSE}
cat(paste0("<iframe width=\"100%\"",
           "id=\"reportFrame\" src=\"reports/ensemble-report-",
           dates[1], ".html\"\n"))
cat("  frameborder=\"0\">\n")
cat("</iframe>\n")
```

